<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Roleplay Assistant</title>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
</head>
<body>

<div id="app-container" class="container">
  <div id="left-panel-toggle" class="panel-toggle-handle left-handle">â—€</div>
  <div id="left-panel" class="side-panel left-panel collapsed">
    <button class="btn collapse-handle">ZwiÅ„ &times;</button>
    <div class="panel-section">
      <div class="panel-title">Chats</div>
      <ul id="chat-list" class="chat-list"></ul>
      <div class="form-group" style="margin-top: 15px;">
        <input type="text" id="new-chat-name" class="side-panel-input" placeholder="New chat name...">
        <button id="add-chat-btn" class="btn" style="width:100%; margin-top: 8px;">Create Chat</button>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-title panel-toggle">Persona</div>
      <div class="collapsible-content show">
          <img id="persona-avatar" src="/static/default_avatar.png" style="width:100%; height:auto; aspect-ratio: 1/1; border-radius:12px; object-fit:cover; margin: 0 auto 10px auto; border: 2px solid var(--border);">
          <div style="display:flex; gap: 8px;">
            <select id="side-panel-persona-preset" class="side-panel-input" style="flex:1;"></select>
            <button class="btn" id="side-panel-load-btn">Load</button>
          </div>
          <button class="btn" id="open-persona-modal" style="width:100%; margin-top: 10px;">Full Persona Editor</button>
      </div>
    </div>
  </div>

  <div class="main-panel">
    <div class="chat-header">
      <div class="chat-header-buttons" style="display: none;">
        <button id="mobile-menu-left" class="btn">â˜°</button>
      </div>
      <h1 id="chat-title">AI Roleplay</h1>
      <div style="display: flex; align-items: center; gap: 15px;">
        <div class="status">
          <span id="status-text">Disconnected</span>
          <span id="status-dot" class="status-dot"></span>
        </div>
        <div class="chat-header-buttons" style="display: none;">
          <button id="mobile-menu-right" class="btn">âš™</button>
        </div>
      </div>
    </div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <textarea id="chat-input" class="chat-input" placeholder="Type your message..." rows="1"></textarea>
        <button id="send-btn" class="send-button" disabled>
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px; height:24px;"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
        </button>
        <button id="stop-btn" class="send-button stop-button" style="display: none;">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" style="width:24px; height:24px;"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        </button>
      </div>
    </div>
  </div>

  <div id="right-panel" class="side-panel right-panel collapsed">
    <button class="btn collapse-handle">ZwiÅ„ &times;</button>
    <div class="panel-section">
      <div class="panel-title panel-toggle">Quick Actions</div>
      <div class="collapsible-content show">
          <div class="action-buttons">
            <button class="btn" id="reload-chat">Reload</button>
            <button class="btn" id="new-day">New Day</button>
            <button class="btn" id="check-summary">Check Summary</button>
            <button class="btn" id="force-summary-btn">Summarize</button>
            <button class="btn danger" id="clear-memory">Clear Memory</button>
          </div>
      </div>
    </div>
    <div class="panel-section" id="memory-panel" style="display: none;">
      <div class="panel-title panel-toggle">ðŸ§  Retrieved Memories</div>
      <div id="memory-content" class="collapsible-content show" style="font-size: 0.8em; max-height: 250px; overflow-y: auto; background: var(--bg-secondary); padding: 10px; border-radius: 6px;"></div>
    </div>
    <div class="panel-section">
      <div class="panel-title panel-toggle">Adv Settings</div>
      <div class="collapsible-content">
          <div class="form-group">
            <label for="model-select">Text Model:</label>
            <select id="model-select" class="side-panel-input"></select>
          </div>
          <div class="form-group">
            <label for="embedding-model-select">Embedding Model:</label>
            <select id="embedding-model-select" class="side-panel-input"></select>
          </div>
          <small style="color: var(--text-secondary); font-size: 0.75rem;">(Models must be loaded in LM Studio to appear here)</small>
          <div class="toggle-container">
            <label><span>Persistent Stats</span><input type="checkbox" id="persistent-stats-toggle"></label>
          </div>
          <div class="toggle-container">
            <label><span>Enable Memory (Embeddings)</span><input type="checkbox" id="enable-memory-toggle" checked></label>
          </div>
          <div class="slider-container">
              <label>Temperature: <span id="temp-value">1.0</span></label>
              <input type="range" id="temperature-slider" min="0.1" max="2.5" step="0.05" value="1.0">
          </div>
          <div class="slider-container">
              <label>Max Tokens: <span id="tokens-value">1024</span></label>
              <input type="range" id="tokens-slider" min="256" max="8192" step="128" value="1024">
          </div>
          <div class="slider-container">
              <label>Thought Ratio: <span id="thought-ratio-value">0.5</span></label>
              <input type="range" id="thought-ratio-slider" min="0.0" max="1.5" step="0.05" value="0.5">
          </div>
          <div class="slider-container">
              <label>Talkativeness: <span id="talkativeness-value">0.5</span></label>
              <input type="range" id="talkativeness-slider" min="0.0" max="1.5" step="0.05" value="0.5">
          </div>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-title panel-toggle">World Events</div>
      <div class="collapsible-content">
        <textarea id="world-event-input" class="side-panel-textarea" placeholder="e.g., The sky suddenly turns crimson."></textarea>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="event-type-select" class="side-panel-input" style="flex:1;">
            <option value="messages">Msg Count</option>
            <option value="time">Minutes</option>
          </select>
          <input type="number" id="event-value-input" class="side-panel-input" value="3" style="flex:1;">
        </div>
        <button class="btn" id="inject-event-btn">Inject Event</button>
      </div>
    </div>
    <div class="panel-section">
      <div class="panel-title panel-toggle">System Info</div>
      <div class="collapsible-content">
          <div style="font-size: 0.875rem; color: var(--text-secondary);">
            <div style="margin-top: 8px;"><button class="btn" id="test-text-model" style="width: 100%;">Test Selected Text Model</button></div>
            <div style="margin-top: 8px;"><button class="btn" id="test-embed" style="width: 100%;">Test Selected Embedding Model</button></div>
            <div style="margin-top: 8px;"><button class="btn" id="open-sys-info-modal" style="width: 100%;">About This App</button></div>
          </div>
      </div>
    </div>
  </div>
  <div id="right-panel-toggle" class="panel-toggle-handle right-handle">â–¶</div>
</div>

<div id="persona-modal" class="modal-backdrop">
  <div class="modal-content">
    <button id="persona-modal-close" class="modal-close-btn">&times;</button>
    <h2>Persona Editor</h2>
    <div class="modal-body">
        <div class="form-group">
            <label for="persona-prompt">Generate from simple prompt:</label>
            <div style="display:flex; gap: 10px;">
                <input type="text" id="persona-prompt" class="modal-input" placeholder="e.g., a brutal ninja from japan that is vicious">
                <button id="generate-persona-btn" class="btn">Generate</button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="persona-editor">Persona JSON:</label>
            <textarea id="persona-editor" class="modal-textarea" style="height: 300px;"></textarea>
            <small style="color: #666; font-size: 0.8em;">Edit the "avatar" field to change image (e.g. "my_char.png"). Place images in personas/img/ folder.</small>
        </div>
    </div>
    <div class="modal-footer">
      <div style="display:flex; flex-direction:column; gap:5px; width:100%;">
          <div style="display:flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 0.85em; color: var(--text-secondary);">Active Chat:</span>
              <button class="btn" id="save-current-persona-btn" style="background: var(--success); border-color: var(--success); color: #fff;">Apply to Current Chat</button>
          </div>
          
          <hr style="border: 0; border-top: 1px solid var(--border); width: 100%; margin: 10px 0;">
          
          <div style="display:flex; flex-direction: column; gap: 8px;">
              <span style="font-size: 0.85em; color: var(--text-secondary);">Manage Presets:</span>
              
              <div style="display:flex; gap: 10px;">
                  <select id="saved-personas-list" class="modal-input" style="flex:1;"></select>
                  <button class="btn" id="load-persona-btn" title="Load selected preset into editor">Load</button>
                  <button class="btn danger" id="overwrite-persona-btn" title="Save changes to the selected preset file">Overwrite</button>
              </div>

              <div style="display:flex; gap: 10px; margin-top: 5px;">
                  <input type="text" id="save-persona-name" class="modal-input" placeholder="New Preset Name" style="flex:1;">
                  <button class="btn" id="save-persona-btn">Save as New</button>
              </div>
          </div>
      </div>
    </div>
  </div>
</div>

<div id="sys-info-modal" class="modal-backdrop">
  <div class="modal-content" style="max-width: 800px;">
    <button id="sys-info-modal-close" class="modal-close-btn">&times;</button>
    <h2 style="border-bottom: 1px solid var(--accent); padding-bottom: 10px; margin-bottom: 15px;">System Architecture & Changelog</h2>
    
    <div id="sys-info-content" class="modal-body" style="line-height: 1.6; white-space: normal; padding-right: 15px;">
        
        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid var(--accent);">
            <h3 style="color: var(--accent); margin-bottom: 10px; margin-top: 0;">AI Narrative Engine v0.9.5</h3>
            <p style="font-size: 0.95em; color: #ccc; margin-bottom: 10px;">
                This is not just a chatbot. It is a <strong>high-fidelity, autonomous roleplay orchestration engine</strong> designed for local deployment. 
                Built on a <strong>RAG (Retrieval-Augmented Generation)</strong> architecture, it utilizes vector embeddings (Faiss/Numpy) to maintain long-term contextual memory and emotional continuity.
            </p>
            <ul style="font-size: 0.9em; color: #ccc; margin-top: 10px; padding-left: 20px; margin-bottom: 0;">
                <li style="margin-bottom: 6px;"><strong>Dynamic State Tracking:</strong> Real-time parsing of internal thoughts, emotional statistics, and narrative reflections.</li>
                <li style="margin-bottom: 6px;"><strong>Context Reconstruction:</strong> Sophisticated prompt engineering algorithms ("Gaslighting" technique) to prevent model drift and enforce strict template adherence.</li>
                <li style="margin-bottom: 6px;"><strong>Semantic Memory:</strong> Deep integration of user interactions into a vector space for semantic retrieval of relevant past events.</li>
                <li><strong>Asynchronous Core:</strong> Built on FastAPI with WebSocket streaming for low-latency, real-time token generation.</li>
            </ul>
        </div>

        <div class="panel-title panel-toggle show" id="changelog-toggle">Build Changelog</div>
        <div id="changelog-content" class="collapsible-content show" style="font-family: monospace; font-size: 0.85rem; color: var(--text-secondary); white-space: pre-wrap; margin-top: 10px;">
<span style="color: var(--success)">[v0.9.5] - Stability & UI Polish</span>
- IMPLEMENTED: "Force-Think" Logic to synchronize frontend/backend parsing during streaming.
- ADDED: Full support for `**[[Response]]**` headers to prevent thought/content bleeding.
- FIXED: CSS Box Model issues causing "Giant Bubbles" in user interface (aggressive margin reset).
- OPTIMIZED: JavaScript Regex engine to handle erratic model outputs (missing asterisks, inline lists).
- ADDED: "New Day" logic with automated summarization and context reset.

<span style="color: var(--accent)">[v0.9.0] - Core Architecture Refactor</span>
- REFACTORED: Consolidated duplicate logic from `bot.py` into modular `storage.py` and `response_parser.py`.
- ADDED: Vector Embedding memory system with semantic search.
- ADDED: Persistent emotional stats tracking.
        </div>
        
        <div style="margin-top: 20px; font-size: 0.8em; text-align: right; color: var(--text-secondary); border-top: 1px solid var(--border); padding-top: 10px;">
            Powered by <span id="sys-info-model" style="color: #fff;">Unknown</span> | Client Version: <span id="sys-info-version">Unknown</span>
            <br>Author: <a href="https://github.com/wieszjak" target="_blank" style="color: var(--accent);">WIESZJAK</a>
        </div>
    </div>
  </div>
</div>

<div id="summary-modal" class="modal-backdrop">
    <div class="modal-content">
      <button id="summary-modal-close" class="modal-close-btn">&times;</button>
      <h2>Last Summary</h2>
      <div id="summary-modal-body" class="modal-body message-body" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px;">
        <p>No summary available for this chat yet.</p>
      </div>
    </div>
</div>

<script>
    // Zmienna globalna dla zewnÄ™trznego pliku JS
    window.SERVER_CONFIG = {
        persistentStats: __PERSISTENT_STATS_ENABLED__
    };
</script>
<script src="/static/script.js"></script>
</body>
</html>